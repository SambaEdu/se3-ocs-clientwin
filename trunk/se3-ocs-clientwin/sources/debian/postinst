#!/bin/sh
# postinst script for se3-ocs-clientwin
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package


case "$1" in
    install|configure)

	

	### on suppose que l'on est sous debian  ####
	WWWPATH="/var/www"
	## recuperation des variables necessaires pour interoger mysql ###
	if [ -e $WWWPATH/se3/includes/config.inc.php ]; then
		dbhost=`cat $WWWPATH/se3/includes/config.inc.php | grep "dbhost=" | cut -d = -f2 | cut -d \" -f2`
		dbname=`cat $WWWPATH/se3/includes/config.inc.php | grep "dbname=" | cut	-d = -f 2 |cut -d \" -f 2`
		dbuser=`cat $WWWPATH/se3/includes/config.inc.php | grep "dbuser=" | cut -d = -f 2 | cut -d \" -f 2`
		dbpass=`cat $WWWPATH/se3/includes/config.inc.php | grep "dbpass=" | cut -d = -f 2 | cut -d \" -f 2`
	else
		echo "Fichier de configuration inaccessible, le script ne peut se poursuivre."
		exit 1
	fi

	ADMINSE3_PASS=`echo "SELECT value FROM params WHERE name='xppass'" | mysql -h $dbhost $dbname -u $dbuser -p$dbpass -N`
	if [ "X$ADMINSE3_PASS" = "X" ]; then # if empty
		echo "pas de mot de pass défini pour adminse3"
		exit 1
	fi

# IPSE3=`cat /etc/samba/smb.conf |grep -i interfaces | awk -F' = ' '{ print $2 }'|cut -d '/' -f 1`
#NETBIOS=`cat /etc/samba/smb.conf |grep -i netbios | grep -v ^#.*| awk -F' = ' '{ print $2 }'`
# Modif wawa
NETBIOS=`ldapsearch -xLLL l=maitre cn | grep "cn:" |cut -d" " -f2`
# /Modif wawa
IPSE3=$(net lookup $NETBIOS)
CONF_OCS="/var/se3/Progs/install/ocs-config.bat"
sed -i $CONF_OCS -e s/##NETBIOS_NAME##/$NETBIOS/
sed -i $CONF_OCS -e s/##IPSE3##/$IPSE3/
sed -i $CONF_OCS -e s/##ADMINSE3PASS##/$ADMINSE3_PASS/
chown admin $CONF_OCS
chmod 700 $CONF_OCS 
chown -R admin:admins /var/se3/Progs/ro/inventory
setfacl -R -m m:rwx /var/se3/Progs/ro/inventory
[ -e /home/admin/Bureau/conf-ocs.bat ] && rm -f /home/admin/Bureau/conf-ocs.bat
;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0


